---
import Layout from './Layout.astro';

interface Props {
  title: string;
  description?: string;
  keywords?: string;
}

const { title, description, keywords } = Astro.props;
---

<Layout title={title} description={description} keywords={keywords}>
  <!-- 调整布局比例：主内容区占4份，侧栏占1份（约16个字宽度） -->
  <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
    <!-- 主内容区 (占4份) -->
    <main class="lg:col-span-4">
      <!-- 面包屑导航 -->
      <nav class="text-sm mb-6 text-gray-600 border-b border-gray-200 pb-4">
        <a href="/" class="text-blue-600 hover:text-red-600 hover:underline">首页</a>
        <span class="mx-2">/</span>
        <span class="text-black font-medium">{title}</span>
      </nav>

      <!-- 文章标题 -->
      <h1 class="text-4xl font-bold mb-6 border-b-2 border-black pb-4 leading-tight">{title}</h1>

      <!-- 移动端可折叠目录 -->
      <div class="lg:hidden mb-6">
        <button id="toc-toggle" class="w-full flex items-center justify-between bg-gray-100 hover:bg-gray-200 px-4 py-3 font-bold transition-colors">
          <span>目录</span>
          <svg id="toc-arrow" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <nav id="mobile-toc-list" class="hidden text-sm space-y-0.5 bg-gray-50 px-4 py-3">
          <!-- 目录将通过 JavaScript 动态生成 -->
        </nav>
      </div>

      <!-- 文章内容 -->
      <article class="prose prose-lg max-w-none" id="article-content">
        <slot />
      </article>
    </main>

    <!-- 侧边栏 (占1份，约16个字宽度) -->
    <aside class="lg:col-span-1 border-l-0 lg:border-l border-gray-200 lg:pl-6">
      <div class="lg:sticky lg:top-4">
        <!-- 文档目录 -->
        <div id="toc-container" class="hidden">
          <h3 class="font-bold border-b-2 border-black mb-4 pb-2 text-sm uppercase tracking-wider">
            目录
          </h3>
          <nav id="desktop-toc-list" class="text-sm space-y-0.5">
            <!-- 目录将通过 JavaScript 动态生成 -->
          </nav>
        </div>
      </div>
    </aside>
  </div>
</Layout>

<style>
  /* 文章内容的样式优化 */
  :global(.prose) {
    color: #000;
    font-size: 16px;
    line-height: 1.75;
  }

  :global(.prose a) {
    color: #0000EE;
    text-decoration: none;
    transition: color 0.2s ease;
    word-break: break-word;
  }

  :global(.prose a:hover) {
    color: #FF0000;
    text-decoration: underline;
  }

  :global(.prose a:visited) {
    color: #551A8B;
  }

  /* 标题层级优化 - 所有标题都加粗，字体大小递减 */
  :global(.prose h1) {
    font-size: 2em;
    font-weight: 700;
    margin-top: 1.5em;
    margin-bottom: 0.75em;
    line-height: 1.2;
    border-bottom: 2px solid #000;
    padding-bottom: 0.5em;
  }

  :global(.prose h2) {
    font-size: 1.65em;
    font-weight: 700;
    margin-top: 1.5em;
    margin-bottom: 0.75em;
    line-height: 1.3;
    border-bottom: 1px solid #ccc;
    padding-bottom: 0.5em;
  }

  :global(.prose h3) {
    font-size: 1.35em;
    font-weight: 700;
    margin-top: 1.25em;
    margin-bottom: 0.6em;
    line-height: 1.3;
  }

  :global(.prose h4) {
    font-size: 1.15em;
    font-weight: 700;
    margin-top: 1.1em;
    margin-bottom: 0.5em;
    line-height: 1.4;
  }

  :global(.prose h5) {
    font-size: 1.05em;
    font-weight: 700;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.4;
  }

  :global(.prose h6) {
    font-size: 1em;
    font-weight: 700;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.4;
  }

  /* 段落间距优化 */
  :global(.prose p) {
    margin-bottom: 1.4em;
    font-size: 16px;
    line-height: 1.75;
  }

  :global(.prose ul),
  :global(.prose ol) {
    margin-left: 2em;
    margin-bottom: 1.4em;
  }

  :global(.prose li) {
    margin-bottom: 0.5em;
    font-size: 16px;
    line-height: 1.75;
  }

  /* 修复代码溢出问题 */
  :global(.prose code) {
    background-color: #f5f5f5;
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9em;
    color: #d63384;
    word-break: break-word;
    white-space: pre-wrap;
  }

  :global(.prose pre) {
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    padding: 1.25em;
    overflow-x: auto;
    margin-bottom: 1.4em;
    border-radius: 4px;
    max-width: 100%;
  }

  :global(.prose pre code) {
    background-color: transparent;
    padding: 0;
    color: #000;
    font-size: 0.95em;
    word-break: normal;
    white-space: pre;
  }

  :global(.prose blockquote) {
    border-left: 4px solid #ccc;
    padding-left: 1.25em;
    margin-left: 0;
    margin-bottom: 1.4em;
    color: #666;
    font-style: italic;
  }

  :global(.prose table) {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 1.4em;
    font-size: 16px;
    overflow-x: auto;
    display: block;
  }

  :global(.prose th),
  :global(.prose td) {
    border: 1px solid #ccc;
    padding: 0.75em;
    text-align: left;
  }

  :global(.prose th) {
    background-color: #f5f5f5;
    font-weight: bold;
  }

  :global(.prose img) {
    max-width: 100%;
    height: auto;
    margin: 1.5em 0;
    border: 1px solid #ccc;
  }

  /* 目录样式 - 优化层级展示 */
  #desktop-toc-list {
    display: flex;
    flex-direction: column;
  }

  #desktop-toc-list .toc-item {
    display: block;
    color: #666;
    text-decoration: none;
    padding: 0.35rem 0;
    transition: color 0.2s ease;
    line-height: 1.5;
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
  }

  #desktop-toc-list .toc-item:hover {
    color: #0000EE;
    text-decoration: underline;
  }

  #desktop-toc-list .toc-item.active {
    color: #0000EE;
    font-weight: 600;
  }

  /* 目录层级缩进 - 相对于上一级缩进 */
  #desktop-toc-list .toc-h2 {
    padding-left: 0;
    font-weight: 600;
    margin-top: 0.5em;
  }

  #desktop-toc-list .toc-h2:first-child {
    margin-top: 0;
  }

  #desktop-toc-list .toc-h3 {
    padding-left: 1em;
  }

  #desktop-toc-list .toc-h4 {
    padding-left: 2em;
    font-size: 0.95em;
  }

  /* 移动端可折叠目录样式 */
  #mobile-toc-list .toc-item {
    display: block;
    color: #666;
    text-decoration: none;
    padding: 0.5em 0;
    transition: color 0.2s ease;
    line-height: 1.6;
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    width: 100%;
    box-sizing: border-box;
  }

  #mobile-toc-list .toc-item:hover {
    color: #0000EE;
    text-decoration: underline;
  }

  #mobile-toc-list .toc-item.active {
    color: #0000EE;
    font-weight: 600;
  }

  /* 移动端响应式 */
  @media (max-width: 768px) {
    :global(.prose) {
      font-size: 16px;
    }

    :global(.prose h1) {
      font-size: 1.75em;
    }

    :global(.prose h2) {
      font-size: 18px;
      font-weight: 700;
    }

    :global(.prose h3) {
      font-size: 17px;
      font-weight: 700;
    }

    :global(.prose h4) {
      font-size: 16px;
      font-weight: 700;
    }

    :global(.prose h5),
    :global(.prose h6) {
      font-size: 1em;
    }

    :global(.prose p) {
      font-size: 16px;
    }

    :global(.prose li) {
      font-size: 15px;
    }

    :global(.prose pre) {
      padding: 1em;
      font-size: 0.9em;
    }

    /* 移动端目录列表样式 - 覆盖全局 flex 布局 */
    #mobile-toc-list {
      display: block !important;
    }

    #mobile-toc-list.hidden {
      display: none !important;
    }

    /* 移动端目录项确保换行 */
    #mobile-toc-list .toc-item {
      display: block !important;
      white-space: normal !important;
      width: 100% !important;
      overflow-wrap: break-word !important;
      word-break: break-word !important;
    }

    /* 移动端目录层级缩进 */
    #mobile-toc-list .toc-h2 {
      padding-left: 0;
      font-weight: 600;
      margin-top: 0.5em;
    }

    #mobile-toc-list .toc-h2:first-child {
      margin-top: 0;
    }

    #mobile-toc-list .toc-h3 {
      padding-left: 1.5em;
    }

    #mobile-toc-list .toc-h4 {
      padding-left: 2.5em;
      font-size: 0.95em;
    }

    /* 折叠箭头旋转动画 */
    .rotate-180 {
      transform: rotate(180deg);
    }
  }
</style>

<script>
  // 生成文档目录
  function generateTOC() {
    const article = document.getElementById('article-content');
    const tocContainer = document.getElementById('toc-container');
    const mobileTocList = document.getElementById('mobile-toc-list');
    const desktopTocList = document.getElementById('desktop-toc-list');
    const tocToggle = document.getElementById('toc-toggle');
    const tocArrow = document.getElementById('toc-arrow');

    if (!article) return;

    const headings = article.querySelectorAll('h2, h3, h4');

    // 移动端处理
    if (window.innerWidth <= 768) {
      if (mobileTocList && tocToggle) {
        if (headings.length === 0) {
          tocToggle.classList.add('hidden');
          return;
        }

        tocToggle.classList.remove('hidden');

        let tocHTML = '';

        headings.forEach((heading, index) => {
          const id = `heading-${index}`;
          heading.id = id;

          const level = parseInt(heading.tagName[1]);
          const text = heading.textContent || '';
          const levelClass = `toc-h${level}`;

          tocHTML += `<a href="#${id}" class="toc-item ${levelClass}">${text}</a>`;
        });

        mobileTocList.innerHTML = tocHTML;

        // 点击切换目录显示/隐藏
        tocToggle.addEventListener('click', () => {
          mobileTocList.classList.toggle('hidden');
          tocArrow.classList.toggle('rotate-180');
        });

        // 点击目录项后自动折叠
        mobileTocList.querySelectorAll('.toc-item').forEach(item => {
          item.addEventListener('click', () => {
            mobileTocList.classList.add('hidden');
            tocArrow.classList.remove('rotate-180');
          });
        });
      }
      return;
    }

    // 桌面端处理
    if (!tocContainer || !desktopTocList) return;

    if (headings.length === 0) {
      tocContainer.classList.add('hidden');
      return;
    }

    tocContainer.classList.remove('hidden');

    let tocHTML = '';

    headings.forEach((heading, index) => {
      const id = `heading-${index}`;
      heading.id = id;

      const level = parseInt(heading.tagName[1]);
      const text = heading.textContent || '';
      const levelClass = `toc-h${level}`;

      tocHTML += `<a href="#${id}" class="toc-item ${levelClass}">${text}</a>`;
    });

    desktopTocList.innerHTML = tocHTML;

    // 滚动高亮当前标题
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            document.querySelectorAll('#desktop-toc-list .toc-item').forEach((link) => {
              link.classList.remove('active');
            });
            const activeLink = document.querySelector(`#desktop-toc-list a[href="#${id}"]`);
            if (activeLink) {
              activeLink.classList.add('active');
            }
          }
        });
      },
      { rootMargin: '-100px 0px -66%' }
    );

    headings.forEach((heading) => {
      observer.observe(heading);
    });
  }

  // 页面加载完成后执行
  document.addEventListener('DOMContentLoaded', () => {
    generateTOC();
  });
</script>
