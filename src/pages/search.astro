---
import Layout from '../layouts/Layout.astro';
import { getAllPosts, getAllTags } from '../utils/posts';

const allPosts = await getAllPosts();
const allTags = await getAllTags();

// 获取搜索查询参数
const query = Astro.url.searchParams.get('q') || '';

// 搜索文章标题
const searchResults = query 
  ? allPosts.filter(post => 
      post.title.toLowerCase().includes(query.toLowerCase())
    )
  : [];
---

<Layout title={`搜索: ${query}`} description={`搜索结果: ${query}`}>
  <!-- 双栏布局 -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
    <!-- 主内容区 (占3份) -->
    <main class="md:col-span-3">
      <!-- 面包屑导航 -->
      <nav class="text-sm mb-4 text-gray-600">
        <a href="/" class="hover:text-black">首页</a>
        <span class="mx-2">/</span>
        <span class="text-black">搜索</span>
      </nav>

      <!-- 搜索标题 -->
      <h1 class="text-2xl font-bold mb-4 border-b-2 border-black pb-2">
        搜索: "{query}"
        <span class="text-sm text-gray-500 ml-2">({searchResults.length} 篇文章)</span>
      </h1>

      {searchResults.length > 0 ? (
        <div class="mb-8">
          <!-- 列表容器 -->
          <ul class="space-y-0 text-base">
            {searchResults.map(post => (
              <li class="group py-2 border-b border-dotted border-gray-300 flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-4 hover:bg-gray-50 transition-colors">
                <span class="font-mono text-gray-500 text-xs w-24 flex-shrink-0">
                  [{post.date ? new Date(post.date).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) : ''}]
                </span>
                <div class="flex-grow">
                  <a href={`/posts/${post.slug}`} class="text-[#0000EE] hover:text-[#FF0000] font-medium visited:text-[#551A8B] text-lg">
                    {post.title}
                  </a>
                  {post.description && (
                    <p class="text-sm text-gray-600 mt-1">{post.description}</p>
                  )}
                </div>
                {post.tags.length > 0 && (
                  <a href={`/tags/${post.tags[0]}`} class="text-xs text-gray-500 hover:text-gray-800 bg-gray-100 px-1 border border-gray-200 rounded-none whitespace-nowrap">
                    #{post.tags[0]}
                  </a>
                )}
              </li>
            ))}
          </ul>
        </div>
      ) : (
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg">未找到匹配的文章</p>
          <p class="text-gray-400 text-sm mt-2">尝试使用不同的关键词</p>
        </div>
      )}
    </main>

    <!-- 侧边栏 (占1份) -->
    <aside class="md:col-span-1 border-l-0 md:border-l border-gray-200 md:pl-6 space-y-8">
      <!-- 标签云 -->
      <div>
        <h3 class="font-bold border-b-2 border-black mb-3 pb-1 text-sm uppercase tracking-wide">
          标签
        </h3>
        <div class="flex flex-wrap gap-x-3 gap-y-1 text-sm leading-relaxed text-gray-700">
          {allTags.map(tag => (
            <a href={`/tags/${tag}`} class="text-[#0000EE] hover:text-[#FF0000] hover:underline">
              [#{tag}]
            </a>
          ))}
        </div>
      </div>
    </aside>
  </div>
</Layout>
