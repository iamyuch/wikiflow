---
import Layout from '../layouts/Layout.astro';
---

<Layout title="æœç´¢" description="æœç´¢æ–‡ç« ">
  <!-- å•æ å¸ƒå±€ -->
  <div>
    <!-- ä¸»å†…å®¹åŒº -->
    <main>
      <!-- é¢åŒ…å±‘å¯¼èˆª -->
      <nav class="text-sm mb-6 text-gray-600 border-b border-gray-200 pb-4">
        <a href="/" class="text-blue-600 hover:text-red-600 hover:underline">é¦–é¡µ</a>
        <span class="mx-2">/</span>
        <span class="text-black font-medium">æœç´¢</span>
      </nav>

      <!-- æœç´¢æ ‡é¢˜ -->
      <h1 class="text-3xl font-bold mb-6 border-b-2 border-black pb-4">
        <span id="search-title">æœç´¢æ–‡ç« </span>
        <span id="result-count" class="text-base text-gray-500 ml-3 font-normal hidden"></span>
      </h1>

      <!-- åŠ è½½çŠ¶æ€ -->
      <div id="loading" class="hidden text-center py-16 bg-gray-50 border border-gray-200">
        <p class="text-gray-600 text-lg">ğŸ” æœç´¢ä¸­...</p>
      </div>

      <!-- æœç´¢ç»“æœå®¹å™¨ -->
      <div id="search-results" class="mb-8">
        <!-- ç»“æœå°†é€šè¿‡ JavaScript åŠ¨æ€æ’å…¥ -->
      </div>

      <!-- ç©ºçŠ¶æ€ -->
      <div id="empty-state" class="text-center py-16 bg-gray-50 border border-gray-200">
        <p class="text-gray-600 text-lg mb-2">ğŸ” è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</p>
        <p class="text-gray-500 text-sm">æœç´¢èŒƒå›´ï¼šæ–‡ç« æ ‡é¢˜</p>
      </div>

      <!-- æ— ç»“æœçŠ¶æ€ -->
      <div id="no-results" class="hidden text-center py-16 bg-gray-50 border border-gray-200">
        <p class="text-gray-600 text-lg mb-2">ğŸ˜” æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </p>
        <p class="text-gray-500 text-sm">å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯</p>
      </div>
    </main>
  </div>
</Layout>

<script>
  interface Post {
    slug: string;
    title: string;
    description: string;
    category: string;
    date: string;
  }

  let allPosts: Post[] = [];

  // è·å– URL å‚æ•°
  function getQueryParam(param: string): string {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param) || '';
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  function formatDate(dateString: string): string {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN');
  }

  // æ¸²æŸ“æœç´¢ç»“æœ
  function renderResults(posts: Post[], query: string) {
    const searchTitle = document.getElementById('search-title');
    const resultCount = document.getElementById('result-count');
    const searchResults = document.getElementById('search-results');
    const emptyState = document.getElementById('empty-state');
    const noResults = document.getElementById('no-results');
    const loading = document.getElementById('loading');

    if (!searchTitle || !resultCount || !searchResults || !emptyState || !noResults || !loading) return;

    // éšè—åŠ è½½çŠ¶æ€
    loading.classList.add('hidden');

    if (!query) {
      // æ˜¾ç¤ºç©ºçŠ¶æ€
      emptyState.classList.remove('hidden');
      noResults.classList.add('hidden');
      searchResults.innerHTML = '';
      searchTitle.textContent = 'æœç´¢æ–‡ç« ';
      resultCount.classList.add('hidden');
      return;
    }

    // æ›´æ–°æ ‡é¢˜
    searchTitle.textContent = `æœç´¢: "${query}"`;
    resultCount.textContent = `(${posts.length} ç¯‡æ–‡ç« )`;
    resultCount.classList.remove('hidden');

    if (posts.length === 0) {
      // æ˜¾ç¤ºæ— ç»“æœçŠ¶æ€
      emptyState.classList.add('hidden');
      noResults.classList.remove('hidden');
      searchResults.innerHTML = '';
      return;
    }

    // éšè—ç©ºçŠ¶æ€
    emptyState.classList.add('hidden');
    noResults.classList.add('hidden');

    // æ¸²æŸ“ç»“æœåˆ—è¡¨
    const html = `
      <ul class="space-y-0 text-base border-t border-gray-300">
        ${posts.map(post => `
          <li class="group py-3 border-b border-gray-300 hover:bg-gray-50 transition-colors">
            <div class="flex flex-col sm:flex-row sm:items-baseline gap-2">
              <a 
                href="/posts/${post.slug}" 
                class="text-blue-600 hover:text-red-600 hover:underline visited:text-purple-800 font-medium text-lg flex-grow"
              >
                ${post.title}
              </a>
              <div class="flex items-center gap-3 flex-shrink-0">
                ${post.category ? `
                  <span class="text-xs text-gray-600 bg-gray-100 px-2 py-0.5 border border-gray-300">
                    ${post.category}
                  </span>
                ` : ''}
                ${post.date ? `
                  <span class="text-xs text-gray-500 font-mono">
                    ${formatDate(post.date)}
                  </span>
                ` : ''}
              </div>
            </div>
            ${post.description ? `
              <p class="text-sm text-gray-600 mt-1.5 line-clamp-2">${post.description}</p>
            ` : ''}
          </li>
        `).join('')}
      </ul>
    `;

    searchResults.innerHTML = html;
  }

  // æ‰§è¡Œæœç´¢
  function performSearch(query: string) {
    if (!query) {
      renderResults([], '');
      return;
    }

    const results = allPosts.filter(post => 
      post.title.toLowerCase().includes(query.toLowerCase())
    );

    renderResults(results, query);
  }

  // åŠ è½½æ–‡ç« æ•°æ®å¹¶æ‰§è¡Œæœç´¢
  async function loadAndSearch() {
    const loading = document.getElementById('loading');
    const emptyState = document.getElementById('empty-state');
    
    if (!loading || !emptyState) return;

    try {
      const query = getQueryParam('q');
      
      if (query) {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        loading.classList.remove('hidden');
        emptyState.classList.add('hidden');
      }

      // åŠ è½½æ–‡ç« æ•°æ®
      const response = await fetch('/api/posts.json');
      allPosts = await response.json();

      // æ‰§è¡Œæœç´¢
      performSearch(query);
    } catch (error) {
      console.error('Failed to load posts:', error);
      const loading = document.getElementById('loading');
      if (loading) {
        loading.innerHTML = '<p class="text-red-600">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
      }
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
  document.addEventListener('DOMContentLoaded', () => {
    loadAndSearch();
  });
</script>
