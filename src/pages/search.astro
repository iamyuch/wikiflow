---
import Layout from '../layouts/Layout.astro';
import { getAllPosts, getAllTags } from '../utils/posts';

const allPosts = await getAllPosts();
const allTags = await getAllTags();

// è·å–æœç´¢æŸ¥è¯¢å‚æ•°
const query = Astro.url.searchParams.get('q') || '';

// æœç´¢æ–‡ç« æ ‡é¢˜ï¼ˆå·²ç»æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼‰
const searchResults = query 
  ? allPosts.filter(post => 
      post.title.toLowerCase().includes(query.toLowerCase())
    )
  : [];
---

<Layout title={query ? `æœç´¢: ${query}` : 'æœç´¢'} description={`æœç´¢ç»“æœ: ${query}`}>
  <!-- åŒæ å¸ƒå±€ -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
    <!-- ä¸»å†…å®¹åŒº (å 3ä»½) -->
    <main class="md:col-span-3">
      <!-- é¢åŒ…å±‘å¯¼èˆª -->
      <nav class="text-sm mb-6 text-gray-600 border-b border-gray-200 pb-4">
        <a href="/" class="text-blue-600 hover:text-red-600 hover:underline">é¦–é¡µ</a>
        <span class="mx-2">/</span>
        <span class="text-black font-medium">æœç´¢</span>
      </nav>

      <!-- æœç´¢æ ‡é¢˜ -->
      <h1 class="text-3xl font-bold mb-6 border-b-2 border-black pb-4">
        {query ? (
          <>
            æœç´¢: "{query}"
            <span class="text-base text-gray-500 ml-3 font-normal">({searchResults.length} ç¯‡æ–‡ç« )</span>
          </>
        ) : (
          'æœç´¢æ–‡ç« '
        )}
      </h1>

      {query ? (
        searchResults.length > 0 ? (
          <div class="mb-8">
            <!-- æ–‡ç« åˆ—è¡¨ -->
            <ul class="space-y-0 text-base border-t border-gray-300">
              {searchResults.map(post => (
                <li class="group py-3 border-b border-gray-300 hover:bg-gray-50 transition-colors">
                  <div class="flex flex-col sm:flex-row sm:items-baseline gap-2">
                    <a 
                      href={`/posts/${post.slug}`} 
                      class="text-blue-600 hover:text-red-600 hover:underline visited:text-purple-800 font-medium text-lg flex-grow"
                    >
                      {post.title}
                    </a>
                    <div class="flex items-center gap-3 flex-shrink-0">
                      {post.tags.length > 0 && (
                        <div class="flex gap-2">
                          {post.tags.slice(0, 3).map(tag => (
                            <a 
                              href={`/tags/${tag}`} 
                              class="text-xs text-gray-600 hover:text-gray-900 bg-gray-100 px-2 py-0.5 border border-gray-300 hover:bg-gray-200 transition-colors"
                            >
                              #{tag}
                            </a>
                          ))}
                        </div>
                      )}
                      {post.date && (
                        <span class="text-xs text-gray-500 font-mono">
                          {new Date(post.date).toLocaleDateString('zh-CN')}
                        </span>
                      )}
                    </div>
                  </div>
                  {post.description && (
                    <p class="text-sm text-gray-600 mt-1.5 line-clamp-2">{post.description}</p>
                  )}
                </li>
              ))}
            </ul>
          </div>
        ) : (
          <div class="text-center py-16 bg-gray-50 border border-gray-200">
            <p class="text-gray-600 text-lg mb-2">ğŸ˜” æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </p>
            <p class="text-gray-500 text-sm">å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯</p>
          </div>
        )
      ) : (
        <div class="text-center py-16 bg-gray-50 border border-gray-200">
          <p class="text-gray-600 text-lg mb-2">ğŸ” è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</p>
          <p class="text-gray-500 text-sm">æœç´¢èŒƒå›´ï¼šæ–‡ç« æ ‡é¢˜</p>
        </div>
      )}
    </main>

    <!-- ä¾§è¾¹æ  (å 1ä»½) -->
    <aside class="md:col-span-1 border-l-0 md:border-l border-gray-200 md:pl-6 space-y-8">
      <!-- æ ‡ç­¾äº‘ -->
      <div>
        <h3 class="font-bold border-b-2 border-black mb-4 pb-2 text-sm uppercase tracking-wider">
          æ ‡ç­¾
        </h3>
        <div class="flex flex-wrap gap-x-2 gap-y-2 text-sm leading-relaxed text-gray-700">
          {allTags.map(tag => (
            <a 
              href={`/tags/${tag}`} 
              class="text-blue-600 hover:text-red-600 hover:underline"
            >
              [#{tag}]
            </a>
          ))}
        </div>
      </div>
    </aside>
  </div>
</Layout>
